<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Place Your Order - OneOffForged</title>
  <style>
    body{font-family:-apple-system,system-ui,Segoe UI,Arial,sans-serif;margin:0;background:#0b0b0b;color:#eee}
    header{padding:24px 16px;text-align:center}
    .wrap{max-width:960px;margin:0 auto;padding:0 16px 60px}
    .card{background:#121212;border:1px solid #2a2a2a;border-radius:12px;padding:20px;margin-top:12px}
    h1{margin:0;font-size:28px}
    h2{font-size:18px;margin:14px 0 8px}
    label{display:block;font-size:14px;margin:10px 0 6px}
    input,select{width:100%;padding:12px;border-radius:8px;border:1px solid #2a2a2a;background:#181818;color:#eee}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .muted{color:#aaa;font-size:13px}
    .total{font-size:22px;font-weight:700;margin-top:6px}
    .break{color:#bbb}
    .coupon-row{display:grid;grid-template-columns:2fr 1fr;gap:10px}
    .btn{display:inline-block;padding:10px 16px;border-radius:999px;border:1px solid #444;background:#222;color:#fff;text-decoration:none;font-weight:600}
    .btn:hover{opacity:.9}
    .danger{color:#ff6b6b}
    #paypal-button-container{margin-top:18px;min-height:60px;display:flex;align-items:center;justify-content:center}
    #pp-error{color:#ff6b6b;margin-top:10px;white-space:pre-wrap}
    @media (max-width:760px){.row,.row3,.coupon-row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>Place Your Order</h1>
    <div class="muted">Custom forged wheels — 50% deposit now. Sponsor code saves $100.</div>
  </header>

  <div class="wrap">
    <form id="orderForm" class="card" onsubmit="return false;">
      <h2>Contact</h2>
      <div class="row">
        <div>
          <label>Name <span class="danger">*</span></label>
          <input required id="name" />
        </div>
        <div>
          <label>Email <span class="danger">*</span></label>
          <input required type="email" id="email" />
        </div>
      </div>

      <h2>Vehicle (optional)</h2>
      <div class="row3">
        <div><label>Make</label><input id="make"/></div>
        <div><label>Year</label><input id="year"/></div>
        <div><label>Model</label><input id="model"/></div>
      </div>

      <h2>Wheel Specs (optional)</h2>
      <div class="row3">
        <div><label>Size (inch)</label><input id="size" placeholder="e.g. 20"/></div>
        <div><label>Width (J)</label><input id="width" placeholder="e.g. 10J"/></div>
        <div><label>Offset (ET)</label><input id="offset" placeholder="e.g. +35"/></div>
      </div>
      <div class="row3">
        <div><label>Bolt Pattern</label><input id="bp" placeholder="e.g. 5x114.3"/></div>
        <div><label>Center Bore</label><input id="cb" placeholder="e.g. 70.5"/></div>
        <div><label>Color/Finish</label><input id="color" placeholder="e.g. Brushed Clear"/></div>
      </div>

      <h2>Price & Sponsor Code</h2>
      <div class="row">
        <div>
          <label>Total Price (before discount) — USD <span class="danger">*</span></label>
          <input id="basePrice" type="number" step="0.01" placeholder="e.g. 3999" required />
        </div>
        <div>
          <label>Quantity (set)</label>
          <select id="qty"><option>1</option><option>2</option></select>
        </div>
      </div>

      <div class="coupon-row" style="margin-top:8px;">
        <input id="coupon" placeholder="Enter sponsor code (optional)" />
        <a class="btn" href="#" onclick="applyCoupon()">Apply</a>
      </div>
      <div id="couponNote" class="muted" style="margin-top:6px;"></div>

      <h2>Order Summary</h2>
      <div class="total" id="total">$0.00</div>
      <div class="break" id="breakdown"></div>
      <div class="total" style="margin-top:10px;">Deposit (50%): <span id="deposit">$0.00</span></div>
      <div class="muted">Remaining 50% + shipping will be invoiced when the wheels are ready.</div>

      <div id="formError" class="danger" style="margin-top:10px;"></div>
      <div id="pp-error"></div>

      <div id="paypal-button-container"></div>
    </form>

    <div class="card">
      <h2>Notes</h2>
      <ul>
        <li>Lead time depends on style and finish.</li>
        <li>Sponsor codes are case-insensitive; valid code saves $100.</li>
        <li>Shipping and taxes (if any) are billed with the remaining balance.</li>
      </ul>
    </div>
  </div>

  <!-- PayPal JS SDK：开启卡支付，禁用 Pay Later / 信用额度 / Venmo；强制英文 + USD -->
  <script src="https://www.paypal.com/sdk/js?client-id=AWDzLRYQprwHJ0mdDiCkfXeQq1PqqArW0Qpk0GUnvGC0Tk9oYFwkIzngIpnUccoIrHKtrYy-pDQInUMc&currency=USD"></script>

  <script>
    // -------- 金额/优惠逻辑 --------
    const COUPON_SET = new Set(["SPONSOR100","GTCLUB","AZUSA"]);
    function usd(n){return n.toLocaleString(undefined,{style:'currency',currency:'USD'})}
    function calc(){
      const qty = parseInt(document.getElementById('qty').value||'1',10);
      const base = parseFloat(document.getElementById('basePrice').value||'0');
      const subtotal = base*qty;
      const code = (document.getElementById('coupon').value||'').trim().toUpperCase();
      const discount = COUPON_SET.has(code) ? 100 : 0;
      const total = Math.max(subtotal - discount, 0);
      const deposit = total * 0.5;
      return {qty, base, subtotal, discount, total, deposit, code, validCode: COUPON_SET.has(code)};
    }
    function render(){
      const {subtotal, discount, total, deposit, validCode} = calc();
      document.getElementById('total').textContent = usd(total);
      document.getElementById('deposit').textContent = usd(deposit);
      document.getElementById('breakdown').textContent =
        `Subtotal ${usd(subtotal)}${discount>0?` • Discount ${usd(discount)}`:''}`;
      document.getElementById('couponNote').textContent =
        (document.getElementById('coupon').value.trim() ? (validCode ? 'Code applied: -$100' : 'Invalid code') : '');
    }
    function applyCoupon(){ render(); }
    ['basePrice','qty','coupon'].forEach(id=>{
      document.getElementById(id).addEventListener('input', render);
      document.getElementById(id).addEventListener('change', render);
    });

    // -------- 校验 & 订单文本 --------
    function validateForm(){
      const err = document.getElementById('formError'); err.textContent = '';
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const base = parseFloat(document.getElementById('basePrice').value||'0');
      const {deposit} = calc();
      if(!name || !email){ err.textContent='Please fill in name and email.'; return false; }
      if(!(base>0)){ err.textContent='Please enter a valid total price before discount.'; return false; }
      if(deposit < 1){ err.textContent='Deposit must be at least $1.00.'; return false; }
      return true;
    }
    function summaryText(){
      const v=id=>(document.getElementById(id).value||'').trim();
      const s=calc();
      return [
        `Customer: ${v('name')} <${v('email')}>`,
        `Vehicle: ${v('year')} ${v('make')} ${v('model')}`.replace(/\s+/g,' ').trim(),
        `Specs: Size ${v('size')}, Width ${v('width')}, ET ${v('offset')}, BP ${v('bp')}, CB ${v('cb')}, Color ${v('color')}`,
        `Qty: ${s.qty}`,
        `Subtotal: ${usd(s.subtotal)}`,
        `Discount: ${usd(s.discount)} (code: ${s.code||'none'})`,
        `Total: ${usd(s.total)}`,
        `Deposit (50%): ${usd(s.deposit)}`
      ].join(' | ');
    }

    // -------- 等待 PayPal SDK 就绪，再渲染按钮 --------
    function waitForPaypal(maxMs=5000, step=200){
      return new Promise((resolve,reject)=>{
        const start=Date.now();
        (function tick(){
          if (window.paypal && typeof window.paypal.Buttons==='function') return resolve();
          if (Date.now()-start>maxMs) return reject(new Error('SDK timeout'));
          setTimeout(tick, step);
        })();
      });
    }

    function mountButtons(){
      const ppErr = document.getElementById('pp-error');

      paypal.Buttons({
        // 不限定 fundingSource，这样 PayPal 会根据可用性展示 “PayPal” 和 “Debit or Credit Card”
        style:{layout:'vertical', color:'gold', shape:'rect', label:'paypal'},

        // ✅ 用 actions.resolve/reject
        onClick: function (data, actions) {
          if (!validateForm()) return actions.reject();
          return actions.resolve();
        },

        createOrder: function (data, actions) {
          const dep = calc().deposit.toFixed(2);
          if (!(parseFloat(dep) >= 1)) {
            ppErr.textContent = 'Invalid deposit: ' + dep;
            return actions.reject();
          }
          return actions.order.create({
            purchase_units: [{
              amount: { value: dep },
              description: summaryText()
            }],
            application_context: { shipping_preference: 'NO_SHIPPING' }
          });
        },

        onApprove: function (data, actions) {
          return actions.order.capture().then(function () {
            window.location.href = '/thank-you.html';
          });
        },

        onError: function (err) {
          console.error(err);
          ppErr.textContent = 'PayPal error: ' + (err && err.message ? err.message : String(err));
          alert('Payment error. Please try again or contact us.');
        }
      }).render('#paypal-button-container');
    }

    window.addEventListener('DOMContentLoaded', async ()=>{
      render();
      try { await waitForPaypal(); mountButtons(); }
      catch(e){ console.error(e); document.getElementById('pp-error').textContent='❌ PayPal SDK not loaded in time. Try hard refresh (⌘⇧R), Chrome Incognito, disable ad-blockers.'; }
    });
  </script>
</body>
</html>
