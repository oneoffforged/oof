<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Place Your Order - OneOffForged</title>
  <style>
    body{font-family:-apple-system,system-ui,Segoe UI,Arial,sans-serif;margin:0;background:#0b0b0b;color:#eee}
    header{padding:24px 16px;text-align:center}
    .wrap{max-width:960px;margin:0 auto;padding:0 16px 60px}
    .card{background:#121212;border:1px solid #2a2a2a;border-radius:12px;padding:20px;margin-top:12px}
    h1{margin:0;font-size:28px}
    h2{font-size:18px;margin:14px 0 8px}
    label{display:block;font-size:14px;margin:10px 0 6px}
    input,select{width:100%;padding:12px;border-radius:8px;border:1px solid #2a2a2a;background:#181818;color:#eee}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .muted{color:#aaa;font-size:13px}
    .total{font-size:22px;font-weight:700;margin-top:6px}
    .break{color:#bbb}
    .coupon-row{display:grid;grid-template-columns:2fr auto auto;gap:10px;align-items:center}
    .btn{display:inline-block;padding:10px 16px;border-radius:999px;border:1px solid #444;background:#222;color:#fff;text-decoration:none;font-weight:600}
    .btn:hover{opacity:.9}
    .link{color:#8ab4ff;cursor:pointer;text-decoration:underline}
    .danger{color:#ff6b6b}
    #paypal-button-container{margin-top:18px;min-height:60px;display:flex;align-items:center;justify-content:center}
    #pp-error{color:#ff6b6b;margin-top:10px;white-space:pre-wrap}
    @media (max-width:760px){
      .row,.row3,.coupon-row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <h1>Place Your Order</h1>
    <div class="muted">Custom forged wheels — 50% deposit now. Please contact our team before placing your order.</div>
  </header>

  <div class="wrap">
    <form id="orderForm" class="card" onsubmit="return false;">
      <h2>Contact</h2>
      <div class="row">
        <div>
          <label>Name <span class="danger">*</span></label>
          <input required id="name" />
        </div>
        <div>
          <label>Email <span class="danger">*</span></label>
          <input required type="email" id="email" />
        </div>
      </div>

      <h2>Vehicle (optional)</h2>
      <div class="row3">
        <div><label>Make</label><input id="make"/></div>
        <div><label>Year</label><input id="year"/></div>
        <div><label>Model</label><input id="model"/></div>
      </div>

      <h2>Wheel Specs (optional)</h2>
      <div class="row3">
        <div><label>Size (inch)</label><input id="size" placeholder="e.g. 20"/></div>
        <div><label>Width (J)</label><input id="width" placeholder="e.g. 10J"/></div>
        <div><label>Offset (ET)</label><input id="offset" placeholder="e.g. +35"/></div>
      </div>
      <div class="row3">
        <div><label>Bolt Pattern</label><input id="bp" placeholder="e.g. 5x114.3"/></div>
        <div><label>Center Bore</label><input id="cb" placeholder="e.g. 70.5"/></div>
        <div><label>Color/Finish</label><input id="color" placeholder="e.g. Brushed Clear"/></div>
      </div>

      <h2>Price & Sponsor Code</h2>
      <div class="row">
        <div>
          <label>Total Price (before discount) — USD <span class="danger">*</span></label>
          <input id="basePrice" type="number" step="0.01" placeholder="e.g. 3999" required />
        </div>
        <div>
          <label>Quantity (set)</label>
          <select id="qty"><option>1</option><option>2</option></select>
        </div>
      </div>

      <div class="coupon-row" style="margin-top:8px;">
        <input id="coupon" placeholder="Enter sponsor code (optional)" />
        <a class="btn" href=" " onclick="event.preventDefault();applyCoupon();">Apply</a >
        <span id="removeCode" class="link" style="display:none" onclick="clearAppliedCode()">Remove</span>
      </div>
      <div id="couponNote" class="muted" style="margin-top:6px;"></div>

      <h2>Order Summary</h2>
      <div class="total" id="total">$0.00</div>
      <div class="break" id="breakdown"></div>
      <div class="total" style="margin-top:10px;">Deposit (50%): <span id="deposit">$0.00</span></div>
      <div class="muted">Remaining 50% + shipping will be invoiced when the wheels are ready.</div>

      <div id="formError" class="danger" style="margin-top:10px;"></div>
      <div id="pp-error"></div>

      <div id="paypal-button-container"></div>
    </form>

    <div class="card">
      <h2>Notes</h2>
      <ul>
        <li>Lead time depends on style and finish.</li>
        <li>Sponsor codes are case-insensitive. <b>Only one code can be used per order (not stackable).</b></li>
        <li>Shipping and taxes (if any) are billed with the remaining balance.</li>
      </ul>
    </div>
  </div>

  <!-- PayPal JS SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=AWDzLRYQprwHJ0mdDiCkfXeQq1PqqArW0Qpk0GUnvGC0Tk9oYFwkIzngIpnUccoIrHKtrYy-pDQInUMc&currency=USD"></script>

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    // EmailJS init
    (function(){ try{ emailjs.init("6jwlR92OsghT_l7QC"); }catch(e){ console.warn(e); } })();

    // ✅ 两个 sponsor code（大小写不敏感）；命中减 $100；对应通知人
    const COUPON_MAP = {
      "SOCALSHELBYS": { amountOff: 100, notify: ["Socalshelbys2018@gmail.com", "baydarorkun2003@yahoo.com"] },
      "V8FOREVER":    { amountOff: 100, notify: ["baydarorkun2003@yahoo.com"] }
    };

    // 当前“已应用”的 code（只有点击 Apply 成功才会更新）
    let APPLIED_CODE = "";

    function usd(n){ return n.toLocaleString(undefined,{style:'currency',currency:'USD'}) }

    function calc(){
      const qty  = parseInt(document.getElementById('qty').value||'1',10);
      const base = parseFloat(document.getElementById('basePrice').value||'0');
      const subtotal = base * qty;

      // 只使用“已应用”的 APPLIED_CODE 来计算折扣
      const code = (APPLIED_CODE || "").toUpperCase();
      const rule = COUPON_MAP[code];
      const discount = rule ? rule.amountOff : 0;

      const total = Math.max(subtotal - discount, 0);
      const deposit = total * 0.5;

      return { qty, base, subtotal, discount, total, deposit, code, rule };
    }

    function render(){
      const { subtotal, discount, total, deposit } = calc();
      document.getElementById('total').textContent   = usd(total);
      document.getElementById('deposit').textContent = usd(deposit);
      document.getElementById('breakdown').textContent =
        `Subtotal ${usd(subtotal)}${discount>0?` • Discount ${usd(discount)}`:''}`;

      // 提示状态：根据“输入框的值”和“已应用的 APPLIED_CODE”区别显示
      const raw = (document.getElementById('coupon').value||'').trim().toUpperCase();
      const note = document.getElementById('couponNote');
      const remove = document.getElementById('removeCode');

      if (!APPLIED_CODE && !raw) {
        note.textContent = '';
        remove.style.display = 'none';
      } else if (APPLIED_CODE && raw === APPLIED_CODE) {
        note.textContent = `Code applied: -$100 (${APPLIED_CODE})`;
        remove.style.display = 'inline';
      } else if (raw && (!COUPON_MAP[raw])) {
        note.textContent = 'Invalid code';
        remove.style.display = APPLIED_CODE ? 'inline' : 'none';
      } else if (raw && COUPON_MAP[raw] && raw !== APPLIED_CODE) {
        note.textContent = 'Valid code entered, click Apply to use it';
        remove.style.display = APPLIED_CODE ? 'inline' : 'none';
      } else {
        note.textContent = '';
        remove.style.display = APPLIED_CODE ? 'inline' : 'none';
      }
    }

    // 点击 “Apply”：只有在输入的 code 有效时，才更新 APPLIED_CODE 并生效
    function applyCoupon(){
      const raw = (document.getElementById('coupon').value||'').trim().toUpperCase();
      if (COUPON_MAP[raw]) {
        APPLIED_CODE = raw; // 应用成功
      } else {
        APPLIED_CODE = "";  // 无效则清除
      }
      render();
    }

    // 清除已应用的 code
    function clearAppliedCode(){
      APPLIED_CODE = "";
      // 保留输入框里的文字，提示“未应用”
      render();
    }

    // base price / qty 改变立即影响金额（coupon 只在 Apply 后生效）
    ['basePrice','qty'].forEach(id=>{
      document.getElementById(id).addEventListener('input', render);
      document.getElementById(id).addEventListener('change', render);
    });
    // coupon 输入时不改变金额，但更新提示
    document.getElementById('coupon').addEventListener('input', render);
    document.getElementById('coupon').addEventListener('change', render);

    function validateForm(){
      const err = document.getElementById('formError'); err.textContent='';
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const base = parseFloat(document.getElementById('basePrice').value||'0');
      const { deposit } = calc();
      if(!name || !email){ err.textContent='Please fill in name and email.'; return false; }
      if(!(base>0)){ err.textContent='Please enter a valid total price before discount.'; return false; }
      if(deposit < 1){ err.textContent='Deposit must be at least $1.00.'; return false; }
      return true;
    }

    function summaryText(){
      const v=id=>(document.getElementById(id).value||'').trim();
      const s=calc();
      return [
        `Customer: ${v('name')} <${v('email')}>`,
        `Vehicle: ${v('year')} ${v('make')} ${v('model')}`.replace(/\s+/g,' ').trim(),
        `Specs: Size ${v('size')}, Width ${v('width')}, ET ${v('offset')}, BP ${v('bp')}, CB ${v('cb')}, Color ${v('color')}`,
        `Qty: ${s.qty}`,
        `Subtotal: ${usd(s.subtotal)}`,
        `Discount: ${usd(s.discount)} (code: ${s.code || 'none'})`,
        `Total: ${usd(s.total)}`,
        `Deposit (50%): ${usd(s.deposit)}`
      ].join(' | ');
    }

    // 老板通知（含 order_summary）
    const OWNER_EMAIL = "oneoffforged@gmail.com";
    function notifyOwnerAlways(){
      try{
        const orderSummary = summaryText();
        const codeUpper = (APPLIED_CODE || "");
        return emailjs.send("service_vs35vuk", "template_0w8kko5", {
          email: OWNER_EMAIL,
          code:  codeUpper,
          order_summary: orderSummary
        }).then(res=>{
          console.log("Owner notice sent", res.status);
        }).catch(err=>{
          console.warn("Owner notice failed", err);
        });
      }catch(e){
        console.warn("notifyOwnerAlways error", e);
      }
    }

    // 赞助人通知（只发 code）
    function sendSponsorEmailsByCode(){
      const codeUpper = (APPLIED_CODE || "");
      const entry = COUPON_MAP[codeUpper];
      if (!entry) return; // 未使用可用的 sponsor code 则不发
      (entry.notify || []).forEach(function(emailAddr){
        emailjs.send("service_vs35vuk", "template_0w8kko5", {
          email: emailAddr,
          code:  codeUpper
        }).then(function(res){
          console.log("Sponsor email sent to", emailAddr, res.status);
        }).catch(function(err){
          console.error("Sponsor email failed for", emailAddr, err);
        });
      });
    }

    // PayPal Buttons
    function waitForPaypal(maxMs=8000, step=200){
      return new Promise((resolve,reject)=>{
        const start=Date.now();
        (function tick(){
          if (window.paypal && typeof window.paypal.Buttons==='function') return resolve();
          if (Date.now()-start>maxMs) return reject(new Error('SDK timeout'));
          setTimeout(tick, step);
        })();
      });
    }

    function mountButtons(){
      const ppErr = document.getElementById('pp-error');
      paypal.Buttons({
        style:{ layout:'vertical', color:'gold', shape:'rect', label:'paypal' },

        onClick: function(data, actions){
          if (!validateForm()) return actions.reject();
          return actions.resolve();
        },

        createOrder: function(data, actions){
          const dep = calc().deposit.toFixed(2); // 基于“已应用”的 code 计算
          if (!(parseFloat(dep) >= 1)) {
            ppErr.textContent = 'Invalid deposit: ' + dep;
            return actions.reject();
          }
          return actions.order.create({
            purchase_units: [{
              amount: { value: dep },
              description: summaryText()
            }],
            application_context: { shipping_preference: 'NO_SHIPPING' }
          });
        },

        onApprove: function(data, actions){
          return actions.order.capture().then(function(){
            try { sendSponsorEmailsByCode(); } catch(e){}
            try { notifyOwnerAlways(); } catch(e){}
            window.location.href = '/thank-you.html';
          });
        },

        onError: function(err){
          console.error(err);
          ppErr.textContent = 'PayPal error: ' + (err && err.message ? err.message : String(err));
          alert('Payment error. Please try again or contact us.');
        }
      }).render('#paypal-button-container');
    }

    window.addEventListener('DOMContentLoaded', async ()=>{
      render();
      try { await waitForPaypal(); mountButtons(); }
      catch(e){ console.error(e); document.getElementById('pp-error').textContent='❌ PayPal SDK not loaded in time. Try hard refresh (⌘⇧R), Chrome Incognito, disable ad-blockers.'; }
    });
  </script>
</body>
</html>
