<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Place Your Order - OneOffForged</title>
  <style>
    body{font-family:-apple-system,system-ui,Segoe UI,Arial,sans-serif;margin:0;background:#0b0b0b;color:#eee}
    header{padding:24px 16px;text-align:center}
    .wrap{max-width:960px;margin:0 auto;padding:0 16px 60px}
    .card{background:#121212;border:1px solid #2a2a2a;border-radius:12px;padding:20px;margin-top:12px}
    h1{margin:0;font-size:28px}
    h2{font-size:18px;margin:14px 0 8px}
    label{display:block;font-size:14px;margin:10px 0 6px}
    input,select,textarea{width:100%;padding:12px;border-radius:8px;border:1px solid #2a2a2a;background:#181818;color:#eee}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .muted{color:#aaa;font-size:13px}
    .total{font-size:22px;font-weight:700;margin-top:6px}
    .break{color:#bbb}
    .coupon-row{display:grid;grid-template-columns:2fr 1fr;gap:10px}
    .btn{display:inline-block;padding:10px 16px;border-radius:999px;border:1px solid #444;background:#222;color:#fff;text-decoration:none;font-weight:600}
    .btn:hover{opacity:.9}
    .danger{color:#ff6b6b}
    #paypal-button-container{margin-top:18px}
    @media (max-width:760px){.row,.row3,.coupon-row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>Place Your Order</h1>
    <div class="muted">Custom forged wheels — pay a 50% deposit now. Sponsor code knocks $100 off the total.</div>
  </header>

  <div class="wrap">
    <form id="orderForm" class="card" onsubmit="return false;">
      <h2>Contact</h2>
      <div class="row">
        <div>
          <label>Name <span class="danger">*</span></label>
          <input required name="name" id="name" />
        </div>
        <div>
          <label>Email <span class="danger">*</span></label>
          <input required type="email" name="email" id="email" />
        </div>
      </div>

      <h2>Vehicle (optional)</h2>
      <div class="row3">
        <div><label>Make</label><input name="make" id="make"/></div>
        <div><label>Year</label><input name="year" id="year"/></div>
        <div><label>Model</label><input name="model" id="model"/></div>
      </div>

      <h2>Wheel Specs (optional)</h2>
      <div class="row3">
        <div><label>Size (inch)</label><input name="size" id="size" placeholder="e.g. 20"/></div>
        <div><label>Width (J)</label><input name="width" id="width" placeholder="e.g. 10J"/></div>
        <div><label>Offset (ET)</label><input name="offset" id="offset" placeholder="e.g. +35"/></div>
      </div>
      <div class="row3">
        <div><label>Bolt Pattern</label><input name="bp" id="bp" placeholder="e.g. 5x114.3"/></div>
        <div><label>Center Bore</label><input name="cb" id="cb" placeholder="e.g. 70.5"/></div>
        <div><label>Color/Finish</label><input name="color" id="color" placeholder="e.g. Brushed Clear"/></div>
      </div>

      <h2>Price & Sponsor Code</h2>
      <div class="row">
        <div>
          <label>Total Price (before discount) — USD <span class="danger">*</span></label>
          <input id="basePrice" type="number" step="0.01" placeholder="e.g. 3999" required />
          <div class="muted">Enter full set price. We apply sponsor discount first, then calculate 50% deposit.</div>
        </div>
        <div>
          <label>Quantity (set)</label>
          <select id="qty"><option>1</option><option>2</option></select>
        </div>
      </div>

      <div class="coupon-row" style="margin-top:8px;">
        <input id="coupon" placeholder="Enter sponsor code (optional)" />
        <a class="btn" href="#" onclick="applyCoupon()">Apply</a>
      </div>
      <div id="couponNote" class="muted" style="margin-top:6px;"></div>

      <h2>Order Summary</h2>
      <div class="total" id="total">$0.00</div>
      <div class="break" id="breakdown"></div>
      <div class="total" style="margin-top:10px;">Deposit (50%): <span id="deposit">$0.00</span></div>
      <div class="muted">Remaining 50% + shipping will be invoiced when the wheels are ready.</div>

      <div id="formError" class="danger" style="margin-top:10px;"></div>

      <div id="paypal-button-container"></div>
    </form>

    <div class="card">
      <h2>Notes</h2>
      <ul>
        <li>Lead time depends on style and finish.</li>
        <li>Sponsor codes are case-insensitive; invalid codes will not apply.</li>
        <li>Shipping and taxes (if any) are billed with the remaining balance.</li>
      </ul>
    </div>
  </div>

  <!-- PayPal JS SDK
       强制英文：locale=en_US
       仅显示 PayPal：disable-funding=card,paylater,credit,venmo
  -->
  <script src="https://www.paypal.com/sdk/js?client-id=AWDzLRYQprwHJ0mdDiCkfXeQq1PqqArW0Qpk0GUnvGC0Tk9oYFwkIzngIpnUccoIrHKtrYy-pDQInUMc&currency=USD&locale=en_US&components=buttons&intent=CAPTURE&commit=true&disable-funding=card,paylater,credit,venmo"></script>

  <!-- 可选：EmailJS（前端直发邮件）。若不配置，将自动走 mailto 备用方案 -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    // ===== 如使用 EmailJS，请填入这 3 个 ID（否则留空使用 mailto 备用）=====
    const EMAILJS_PUBLIC_KEY = "";     // e.g. "J5xxxxxxx_yyyyyy"
    const EMAILJS_SERVICE_ID = "";     // e.g. "service_abc123"
    const EMAILJS_TEMPLATE_ID = "";    // e.g. "template_xyz789"
    const RECEIVER_EMAIL = "oneoffforged@gmail.com";

    if (EMAILJS_PUBLIC_KEY) { try{ emailjs.init(EMAILJS_PUBLIC_KEY); }catch(e){} }

    // ==== Sponsor code：正确 code 让“总价”立减 $100；定金=折后总价的一半 ====
    const COUPON_MAP = {
      "SPONSOR100": { amountOff: 100, note: "Sponsor code applied: -$100" },
      "GTCLUB":     { amountOff: 100, note: "Mustang club: -$100" },
      "AZUSA":      { amountOff: 100, note: "Partner code: -$100" }
    };

    function formatUSD(n){return n.toLocaleString(undefined,{style:'currency',currency:'USD'})}

    function getCalc(){
      const qty = parseInt(document.getElementById('qty').value || '1', 10);
      const base = parseFloat(document.getElementById('basePrice').value || '0');
      const subtotal = base * qty;

      const code = (document.getElementById('coupon').value || '').trim().toUpperCase();
      const rule = COUPON_MAP[code];
      const discount = rule ? 100 : 0;

      const total = Math.max(subtotal - discount, 0);
      const deposit = total * 0.5;

      return { qty, base, subtotal, discount, total, deposit, code, rule };
    }

    function render(){
      const { subtotal, discount, total, deposit, rule } = getCalc();
      document.getElementById('total').textContent = formatUSD(total);
      document.getElementById('deposit').textContent = formatUSD(deposit);
      document.getElementById('breakdown').textContent =
        `Subtotal ${formatUSD(subtotal)}${discount>0?` • Discount ${formatUSD(discount)}`:''}`;
      const note = document.getElementById('couponNote');
      const codeInput = document.getElementById('coupon').value.trim();
      note.textContent = (codeInput && !rule) ? 'Invalid code' : (rule ? rule.note : '');
    }

    function applyCoupon(){ render(); }

    ['basePrice','qty','coupon'].forEach(id=>{
      document.getElementById(id).addEventListener('input', render);
      document.getElementById(id).addEventListener('change', render);
    });
    window.addEventListener('DOMContentLoaded', render);

    function validateForm(){
      const err = document.getElementById('formError');
      err.textContent = '';
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const base = parseFloat(document.getElementById('basePrice').value || '0');
      if(!name || !email){ err.textContent = 'Please fill in name and email.'; return false; }
      if(!(base > 0)){ err.textContent = 'Please enter a valid total price before discount.'; return false; }
      if(getCalc().deposit <= 0){ err.textContent = 'Deposit must be greater than $0.'; return false; }
      return true;
    }

    function collectOrderData(){
      const fields = ['make','year','model','size','width','offset','bp','cb','color'];
      const data = {};
      fields.forEach(f=>data[f]=document.getElementById(f).value.trim());
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const calc = getCalc();
      const summary = [
        `Customer: ${name} <${email}>`,
        `Vehicle: ${data.year||''} ${data.make||''} ${data.model||''}`.replace(/\s+/g,' ').trim(),
        `Specs: Size ${data.size||''}, Width ${data.width||''}, ET ${data.offset||''}, BP ${data.bp||''}, CB ${data.cb||''}, Color ${data.color||''}`,
        `Qty: ${calc.qty}`,
        `Subtotal: ${formatUSD(calc.subtotal)}`,
        `Discount: ${formatUSD(calc.discount)} (code: ${calc.code||'none'})`,
        `Total: ${formatUSD(calc.total)}`,
        `Deposit (50%): ${formatUSD(calc.deposit)}`
      ].join(' | ');
      return { name, email, ...data, ...calc, summary };
    }

    async function notifyByEmail(order){
      try{
        if (EMAILJS_PUBLIC_KEY && EMAILJS_SERVICE_ID && EMAILJS_TEMPLATE_ID && window.emailjs) {
          await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
            to_email: RECEIVER_EMAIL,
            customer_name: order.name,
            customer_email: order.email,
            make: order.make, year: order.year, model: order.model,
            size: order.size, width: order.width, offset: order.offset,
            bp: order.bp, cb: order.cb, color: order.color,
            qty: order.qty,
            subtotal: order.subtotal.toFixed(2),
            discount: order.discount.toFixed(2),
            total: order.total.toFixed(2),
            deposit: order.deposit.toFixed(2),
            coupon_code: order.code || 'none',
            summary: order.summary
          });
          return true;
        }
      }catch(e){
        console.warn("EmailJS send failed, fallback to mailto.", e);
      }
      const subject = encodeURIComponent("New Deposit Order - OneOffForged");
      const body = encodeURIComponent(order.summary);
      const mailto = `mailto:${RECEIVER_EMAIL}?subject=${subject}&body=${body}`;
      window.location.href = mailto;
      return false;
    }

    paypal.Buttons({
      style: { layout: 'vertical', color: 'gold', shape: 'rect', label: 'paypal' },

      onClick: function(){
        if(!validateForm()) return paypal.Actions.reject();
        return paypal.Actions.resolve();
      },

      createOrder: function(data, actions) {
        const calc = getCalc();
        return actions.order.create({
          purchase_units: [{
            amount: { value: calc.deposit.toFixed(2) },
            description: collectOrderData().summary
          }],
          application_context: { shipping_preference: 'NO_SHIPPING' }
        });
      },

      onApprove: function(data, actions) {
        return actions.order.capture().then(async function(details) {
          const order = collectOrderData();
          await notifyByEmail(order);
          window.location.href = "/thank-you.html";
        });
      },

      onError: function(err){
        console.error(err);
        alert('Payment error. Please try again or contact us.');
      }
    }).render('#paypal-button-container');
  </script>
</body>
</html>
